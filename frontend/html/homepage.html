{% extends "base.html" %}

{% block title %}Sublet Scout | Home{% endblock %}

{% block content %}
<div class="container" style="display:flex;gap:1rem;align-items:flex-start;">
  <div style="flex:0 0 360px;">
    <h1>Sublet Scout</h1>
    {% if user_name %}
      <p>Welcome, {{ user_name }}!</p>
    {% else %}
      <p>Welcome!</p>
    {% endif %}
    <p>Find verified student sublets in New York City.</p>

    <h2>Search for Sublets</h2>
    <form action="{{ url_for('show_homepage') }}" method="get" style="display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;">
      <input type="text" id="q" name="q" placeholder="Location (neighborhood or city)" value="{{ query }}" style="flex:1 1 200px;padding:.4rem;">
      <input type="number" id="price" name="price" placeholder="Max $" value="{{ price }}" style="width:110px;padding:.4rem;">
      <div style="display:flex;gap:.5rem;width:100%;">
        <label>Start date<input type="date" id="start_date" name="start_date" style="flex:1 1 160px;padding:.4rem;"></label>
        <label>End date<input type="date" id="end_date" name="end_date" style="flex:1 1 160px;padding:.4rem;"></label>
      </div>
      {% if user_id %}
        <input type="hidden" name="user_id" value="{{ user_id }}">
      {% endif %}
      <button type="submit" style="padding:.45rem 0.9rem;">Search</button>
    </form>
  </div>

  <div style="flex:1;">
    <div id="map" style="height:420px;width:100%;min-width:300px;border:1px solid #ddd;"></div>
  </div>
</div>

<!-- Build listings JS array from template-provided listings -->
<script>
var listings = [
{% for l in listings %}
  {
    id: {{ l.id }},
    title: "{{ l.title|e }}",
    address: "{{ l.full_address|e }}",
    full_address: "{{ l.full_address|e }}",
    latitude: {{ l.latitude if l.latitude is not none else "null" }},
    longitude: {{ l.longitude if l.longitude is not none else "null" }},
    cost_per_month: {{ l.cost_per_month }}
  }{% if not loop.last %},{% endif %}
{% endfor %}
];

// simple escape helper for text inserted into info windows
function escapeHtml(text) {
  return text
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function initMap() {
  var nyc = { lat: 40.7128, lng: -74.0060 };
  var map = new google.maps.Map(document.getElementById('map'), {
    zoom: 12,
    center: nyc
  });

  new google.maps.Marker({ position: nyc, map: map });

  listings.forEach(function(item) {
    if (typeof item.latitude === 'number' && typeof item.longitude === 'number') {
      var pos = { lat: item.latitude, lng: item.longitude };
      var marker = new google.maps.Marker({
        map: map,
        position: pos,
        title: item.title
      });
     var content =
      '<div>' +
        '<strong>' +
          '<a href="/listings/' + item.id + '?user_id={{ user_id }}"' +
            'style="text-decoration:none;color:#1a73e8;">' +
            escapeHtml(item.title) +
          '</a>' +
        '</strong>' +
        '<div>$' + (item.cost_per_month||'') + ' / month</div>' +
        '<div style="font-size:90%;">' + (item.full_address||'') + '</div>' +
      '</div>';


      var info = new google.maps.InfoWindow({ content: content });
      marker.addListener('click', function(){ info.open(map, marker); });
    }
  });
}
</script>

<script async defer
  src="https://maps.googleapis.com/maps/api/js?key={{ map_key }}&callback=initMap">
</script>
{% endblock %}