{% extends "base.html" %}

{% block title %}Sublet Scout | Profile{% endblock %}

{% block content %}
<div class="profile-page">
  <div class="profile-card">
    <h1>User Profile</h1>

    <section class="section">
      <h2>Account Information</h2>
      {% if user %}
        <p><strong>Name:</strong> {{ user.name }}</p>
        <p><strong>Email:</strong> {{ user.email }}</p>
      {% else %}
        <p>User information not available.</p>
      {% endif %}
    </section>

    <section class="section">
      <h2>Your Listings</h2>
      {% if listings and listings|length > 0 %}
        <ul class="listings">
          {% for l in listings %}
            <li>
              <a href="/listings/{{ l.id }}?user={{ user_id }}"><strong>{{ l.title }}</strong> â€“ ${{ l.cost_per_month }}</a>

              {% if l.is_active %}
                <p>Status: <span style="color: green;">Active</span></p>
                <button onclick="toggleListing({{ l.id }}, false)">Deactivate</button>
              {% else %}
                <p>Status: <span style="color: red;">Inactive</span></p>
                <button onclick="toggleListing({{ l.id }}, true)">Activate</button>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p>No listings yet.</p>
      {% endif %}
    </section>

    <section class="section">
      <h2>Incoming Requests</h2>
      <div id="incoming"></div>
    </section>

    <div class="actions">
      <a href="/create_listing" class="btn">Add New Listing</a>
      <form action="/logout" method="POST">
        <button type="submit" class="btn outline">Log out</button>
      </form>
    </div>
  </div>
</div>

<script>
  function toggleListing(listingId, activate) {
      const url = `/listings/${listingId}/` + (activate ? "activate" : "deactivate");

      fetch(url, { method: "POST" })
        .then(r => r.json())
        .then(res => {
          if (res.ok) {
            location.reload();
          } else {
            alert(res.error || "Error updating listing");
          }
        });
  }

  // request functionality
    async function loadRequests() {
      let r = await fetch("/incoming_requests/{{ user_id }}");
      let data = await r.json();

      if (!data || data.length === 0) {
          document.getElementById("incoming").innerHTML = "<p>No requests.</p>";
          return;
      }

      let html = "";
      data.forEach(row => {
          const [req, listing, user] = row;
          html += `
              <div class="req-box">
                  <p><strong>${user.name}</strong> requested <em>${listing.title}</em></p>
                  <button onclick="approve(${req.id})">Approve</button>
                  <button onclick="reject(${req.id})">Reject</button>
              </div>
          `;
      });

      document.getElementById("incoming").innerHTML = html;
  }

  async function approve(id) {
      const res = await fetch(`/booking_requests/${id}/approve?owner_id={{ user_id }}`, {
          method: "POST"
      });
      const data = await res.json();
      if (data.ok) {
          alert("Approved!\n\nOwner: " + data.contact_info.owner_email + "\nRequester: " + data.contact_info.requester_email);
          loadRequests();
      }
  }

  async function reject(id) {
      const res = await fetch(`/booking_requests/${id}/reject?owner_id={{ user_id }}`, {
          method: "POST"
      });
      loadRequests();
  }

  loadRequests();
</script>

{% endblock %}