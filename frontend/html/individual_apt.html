{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', path='individual_apt.css') }}">

<div class="container" style="padding-top: 6.0rem;">
    <h1>{{ apt.title }}</h1>

    <!-- Image Carousel -->
    <div class="carousel">
    <div class="carousel-track">
        {% if apt.image1 %}
        <img src="data:image/webp;base64,{{ apt.image1 }}" class="carousel-img">
        {% endif %}
        {% if apt.image2 %}
        <img src="data:image/webp;base64,{{ apt.image2 }}" class="carousel-img">
        {% endif %}
        {% if apt.image3 %}
        <img src="data:image/webp;base64,{{ apt.image3 }}" class="carousel-img">
        {% endif %}
        {% if apt.image4 %}
        <img src="data:image/webp;base64,{{ apt.image4 }}" class="carousel-img">
        {% endif %}
    </div>

    <div class="carousel-controls">
        <button class="carousel-btn prev">❮</button>
        <button class="carousel-btn next">❯</button>
    </div>
</div>


    <!-- Details -->
    <div class="details">
        <p><strong>Bedrooms Available:</strong> {{ apt.bedrooms_available }}</p>
        <p><strong>Total Rooms:</strong> {{ apt.total_rooms }}</p>
        <p><strong>Bedrooms In Use:</strong> {{ apt.bedrooms_in_use }}</p>
        <p><strong>Bathrooms:</strong> {{ apt.bathrooms }}</p>
        <p><strong>Price:</strong> ${{ "%.2f"|format(apt.cost_per_month) }}/month</p>

        <p><strong>Available:</strong> 
            {{ apt.available_start_date }} to {{ apt.available_end_date }}
        </p>
    </div>

    {% if user_id and user_id != apt.lister %}
        <button id="request-btn">Request Booking</button>
    {% endif %}

    <!-- Map -->
    <div class="map">
        <h2>Location</h2>
        <div id="google-map"></div>
    </div>

    <!-- Amenities -->
    <h2>Amenities</h2>
    <ul>
        {% for amenity in apt.amenities.split(',') %}
            <li>{{ amenity.strip() }}</li>
        {% endfor %}
    </ul>
</div>

<script>
    // Carousel logic
    let index = 0;
    const track = document.querySelector(".carousel-track");
    const images = document.querySelectorAll(".carousel-img");

    document.querySelector(".carousel-btn.next").addEventListener("click", () => {
        index = (index + 1) % images.length;
        track.style.transform = `translateX(-${index * 100}%)`;
    });

    document.querySelector(".carousel-btn.prev").addEventListener("click", () => {
        index = (index - 1 + images.length) % images.length;
        track.style.transform = `translateX(-${index * 100}%)`;
    });


    const pathParts = window.location.pathname.split('/');
    const listing_id = pathParts[2];
    const params = new URLSearchParams(window.location.search);
    const user_id = params.get('user');

    const tmplUserId = {{ "null" if user_id is none else user_id }};
    const currentUserId = tmplUserId || urlUserId;

    const btn = document.getElementById("request-btn");
    if (btn) {
        btn.addEventListener("click", async () => {
            const res = await fetch("/booking_requests", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    listing_id: listing_id,
                    subletter_id: currentUserId
                })
            });
            const data = await res.json();
            if (data.error) {
                alert(data.error);
            } else {
                alert("Request sent!");
                location.reload();
            }
        });
    }

    document.getElementById("requestBooking").onclick = function() {
        console.log("sdajfsakdl");
        fetch('/booking_requests', {method: 'POST',
            headers: { 'Content-Type': 'application/json'},
            body: JSON.stringify({
                listing_id: listing_id,
                subletter_id: user_id
            })
        })
        .then(response => {
            console.log('Fetch response:', response);
        })
        .catch(error => {
            console.error()
        });
    };

    function initMap() {
        const location = { lat: {{ apt.latitude }}, lng: {{apt.longitude}} };
        const map = new google.maps.Map(document.getElementById("google-map"), {
            zoom: 14,
            center: location,
        });
        new google.maps.Marker({
            position: location,
            map: map,
        });
    };

    // request button logic
    if (document.getElementById("request-btn")) {
    document.getElementById("request-btn").addEventListener("click", async () => {
        const res = await fetch("/booking_requests", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                listing_id: {{ listing_id }},
                subletter_id: {{ user_id }}
            })
        });

        const data = await res.json();
        if (data.error) {
            alert(data.error);
        } else {
            alert("Request sent!");
            location.reload();
        }
    });
}

</script>

<script async defer
  src="https://maps.googleapis.com/maps/api/js?key={{ map_key }}&callback=initMap">
</script>

{% endblock %}
