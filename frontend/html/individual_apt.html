{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', path='individual_apt.css') }}">

<div class="listing-wrap">
  <header class="listing-header">
    <h1 class="listing-title">{{ apt.title }}</h1>
    <div class="listing-sub">
      <span><strong>${{ "%.2f"|format(apt.cost_per_month) }}</strong>/month</span>
      <span>{{ apt.bedrooms_available }} beds • {{ apt.bathrooms }} baths</span>
      <span>{{ apt.available_start_date }} – {{ apt.available_end_date }}</span>
    </div>
  </header>

  <section class="listing-grid">
    <!-- Left: details and actions -->
    <aside class="listing-details">
      <h2>Details</h2>
      <ul class="detail-list">
        <li><strong>Bedrooms Available:</strong> {{ apt.bedrooms_available }}</li>
        <li><strong>Total Rooms:</strong> {{ apt.total_rooms }}</li>
        <li><strong>Bedrooms In Use:</strong> {{ apt.bedrooms_in_use }}</li>
        <li><strong>Bathrooms:</strong> {{ apt.bathrooms }}</li>
      </ul>

      <h2>Amenities</h2>
      <ul class="amenities">
        {% for amenity in apt.amenities.split(',') %}
          <li>{{ amenity.strip() }}</li>
        {% endfor %}
      </ul>

      {% if user_id and user_id != apt.lister %}
        <div class="listing-actions">
          <button id="request-btn" class="btn primary">Request Booking</button>
        </div>
      {% endif %}
    </aside>

    <!-- Right: media (carousel + map) -->
    <section class="listing-media">
      <!-- Carousel -->
      <div class="card">
        <div class="carousel">
          <div class="carousel-track">
            {% if apt.image1 %}
              <img src="data:image/webp;base64,{{ apt.image1 }}" class="carousel-img" alt="Photo 1">
            {% endif %}
            {% if apt.image2 %}
              <img src="data:image/webp;base64,{{ apt.image2 }}" class="carousel-img" alt="Photo 2">
            {% endif %}
            {% if apt.image3 %}
              <img src="data:image/webp;base64,{{ apt.image3 }}" class="carousel-img" alt="Photo 3">
            {% endif %}
            {% if apt.image4 %}
              <img src="data:image/webp;base64,{{ apt.image4 }}" class="carousel-img" alt="Photo 4">
            {% endif %}
          </div>
        </div>
        <div class="carousel-controls">
          <button class="carousel-btn prev" aria-label="Previous">❮</button>
          <button class="carousel-btn next" aria-label="Next">❯</button>
        </div>
      </div>

      <!-- Map -->
      <div class="card">
        <h3 class="card-title">Location</h3>
        <div id="google-map"></div>
      </div>
    </section>
  </section>
</div>

<script>
  // Carousel logic
  let index = 0;
  const track = document.querySelector(".carousel-track");
  const images = document.querySelectorAll(".carousel-img");
  const prevBtn = document.querySelector(".carousel-btn.prev");
  const nextBtn = document.querySelector(".carousel-btn.next");

  function updateCarousel() {
    if (!images.length) return;
    track.style.transform = `translateX(-${index * 100}%)`;
  }

  if (nextBtn) {
    nextBtn.addEventListener("click", () => {
      index = (index + 1) % images.length;
      updateCarousel();
    });
  }
  if (prevBtn) {
    prevBtn.addEventListener("click", () => {
      index = (index - 1 + images.length) % images.length;
      updateCarousel();
    });
  }

  // Request booking
  const pathParts = window.location.pathname.split('/');
  const listing_id = pathParts[2];
  const btn = document.getElementById("request-btn");
  if (btn) {
    btn.addEventListener("click", async () => {
      try {
        const res = await fetch("/booking_requests", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            listing_id: listing_id,
            subletter_id: {{ user_id if user_id is not none else 'null' }}
          })
        });
        const data = await res.json();
        if (data.error) {
          alert(data.error);
        } else {
          alert("Request sent!");
          location.reload();
        }
      } catch (e) {
        alert("Something went wrong. Please try again.");
      }
    });
  }

  // Google Map
  function initMap() {
    const location = { lat: {{ apt.latitude }}, lng: {{ apt.longitude }} };
    const map = new google.maps.Map(document.getElementById("google-map"), {
      zoom: 14,
      center: location,
      disableDefaultUI: false,
    });
    new google.maps.Marker({ position: location, map });
  }
  window.initMap = initMap;
</script>

<script async defer
  src="https://maps.googleapis.com/maps/api/js?key={{ map_key }}&callback=initMap"></script>
{% endblock %}
